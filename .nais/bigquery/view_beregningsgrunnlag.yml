apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
kind: BigQueryTable
metadata:
  name: view-beregningsgrunnlag
  namespace: aap
  labels:
    team: aap
  annotations:
    cnrm.cloud.google.com/management-conflict-prevention-policy: none
    cnrm.cloud.google.com/state-into-spec: absent
    cnrm.cloud.google.com/project-id: {{project}}
spec:
  resourceID: view_beregningsgrunnlag
  description: "View som viser beregningsgrunnlag."
  datasetRef:
    external: ytelsestatistikk
  view:
    useLegacySql: false
    query: >-
      SELECT s.saksnummer                                   AS saksnummer,
             br.referanse                                   AS behandlingsreferanse,
             pg.type                                        as type,
             (SELECT CASE pg.type
                         WHEN '11_19' THEN g.grunnlag
                         WHEN 'yrkesskade' THEN gy.grunnlag
                         WHEN 'uføre' THEN gu.grunnlag
                         END)                               AS grunnlaget,
             g.inntekter                                    AS inntekter,
             -- YRKESSKADE
             gy.yrkesskade_tidspunkt                        AS gy_yrkesskade_tidspunkt,
             gy.antatt_arlig_inntekt_yrkesskade_tidspunktet AS gy_antatt_arlig_inntekt_yrkesskade_tidspunktet,
             gy.andel_yrkesskade                            AS gy_andel_yrkesskade,
             -- UFØRE
             gu.uforegrad                                   AS gu_uforegrad,
             gu.ufore_inntekter_fra_foregaende_ar           AS gu_ufore_inntekter_fra_foregaende_ar,
             gu.ufore_ytterligere_nedsatt_arbeidsevne_ar    AS gu_ufore_ytterligere_nedsatt_arbeidsevne_ar,
      FROM datastream_hendelser.public_grunnlag pg
               LEFT OUTER JOIN
           datastream_hendelser.public_grunnlag_11_19 AS g
           ON
               pg.id = g.grunnlag_id
               LEFT OUTER JOIN
           datastream_hendelser.public_grunnlag_yrkesskade AS gy
           ON
               g.id = gy.beregningsgrunnlag_id
               LEFT OUTER JOIN
           datastream_hendelser.public_grunnlag_ufore AS gu
           ON
               g.id = gu.grunnlag_11_19_id
               join
           datastream_hendelser.public_behandling AS b
           ON
               b.id = pg.behandling_id
               join
           datastream_hendelser.public_behandling_referanse br
           ON
               b.referanse_id = br.id
               JOIN
           datastream_hendelser.public_sak s
           ON
               s.id = b.sak_id